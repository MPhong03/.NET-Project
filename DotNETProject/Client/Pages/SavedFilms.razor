@page "/album"
@using DotNETProject.Shared;
@inject HttpClient httpClient

<PageTitle>Bo suu tap</PageTitle>

<div class="container">
    <div class="content-container">

        <!-- MOVIE LIST -->
        <div class="container list">
            <div class="row">
                @if (DisplayedItems.Any())
                {
                    var path = Type == "movie" ? "movie" : "tv";
                    @foreach (var item in DisplayedItems)
                    {
                        <div class="col-lg-2 col-md-3 col-sm-6 col-xs-6">
                            <a href="/@path/@item.Id">
                                <img src="@item.PosterUrl" alt="@item.Name">
                                <p>@item.Name</p>
                            </a>
                        </div>
                    }
                }
                else
                {
                    <div class="col-12 text-light h5 text-center">Không tìm thấy phim bạn muốn xem :(</div>
                }
            </div>
        </div>
        <!-- PAGINATION -->
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
                <li class="page-item @(currentPage == 1 ? "disabled" : "")">
                    <a class="page-link" @onclick="() => GoToPage(currentPage - 1)" tabindex="-1" aria-disabled="@(currentPage == 1 ? "true" : "false")">Previous</a>
                </li>
                @for (var pagenum = 1; pagenum <= TotalPages; pagenum++)
                {
                    <li class="page-item @(currentPage == pagenum ? "active" : "")">
                        <a class="page-link" @onclick="() => GoToPage(pagenum)">@pagenum</a>
                    </li>
                }
                <li class="page-item @(currentPage == TotalPages ? "disabled" : "")">
                    <a class="page-link" @onclick="() => GoToPage(currentPage + 1)">Next</a>
                </li>
            </ul>
        </nav>
    </div>
</div>

@code {
    [Parameter] public string Type { get; set; }
    private IEnumerable<MovieDto> movies = new List<MovieDto>();
    private IEnumerable<TVSeriesDto> shows = new List<TVSeriesDto>();

    private int pageSize = 18;
    private int currentPage = 1;
    private int totalItems;

    private int TotalPages => (int)Math.Ceiling((double)totalItems / pageSize);

    private IEnumerable<FilmDto> DisplayedItems =>
        Type == "movie" ? FilterAndPaginate(movies) : FilterAndPaginate(shows);

    private IEnumerable<FilmDto> FilterAndPaginate(IEnumerable<FilmDto> films)
    {
        var filteredFilms = films;

        totalItems = filteredFilms.Count();
        return filteredFilms.Skip((currentPage - 1) * pageSize).Take(pageSize);
    }

    protected override async Task OnParametersSetAsync()
    {
        if (Type == "movie")
        {
            movies = await httpClient.GetFromJsonAsync<List<MovieDto>>("api/Movies");
        }
        else if (Type == "tvseries")
        {
            shows = await httpClient.GetFromJsonAsync<List<TVSeriesDto>>("api/TVSeries");
        }
    }

    private void GoToPage(int page)
    {
        if (page >= 1 && page <= TotalPages)
        {
            currentPage = page;
        }
    }

}

